{{ 'section-product-anchor-bar.css' | asset_url | stylesheet_tag }}

<div class="product_anchor_bar_section padding-sider">
  <div class="product_anchor_bar">
    <div class="product_anchor_bar_left">
      {% for block in section.blocks %}
        <a
          class="product_anchor_bar_left_item{% if forloop.first %} active{% endif %}"
          {% if forloop.first %}
            href="#"
            data-watch="top"
          {% else %}
            href="#{{ block.settings.anchor_name }}"
            data-watch="{{ block.settings.anchor_name }}"
          {% endif %}
        >
          {{- block.settings.title -}}
        </a>
      {% endfor %}
    </div>
    <button class="product_anchor_bar_btn product_info_buybox_btns_btn nd-btn" data-type="buy_it_now">
      {{ 'common.jetzt_kaufen' | t }}
      {{ 'icon-right-arrow.svg' | inline_asset_content }}
    </button>
  </div>
</div>

<script>
  const links = document.querySelectorAll('.product_anchor_bar_left_item');
  const anchorBarSection = document.querySelector('.product_anchor_bar_section');
  const anchorBarParent = anchorBarSection.parentElement;
  
  // 添加sticky类
  anchorBarParent.classList.add('is-sticky');
  
  // 隐藏主导航（三部分：announcement-bar, header-simple, header-menu）
  const headerSections = document.querySelectorAll('.shopify-section-group-header-group');
  {% comment %} headerSections.forEach(section => {
    section.style.display = 'none';
  }); {% endcomment %}
  
  // 监听滚动事件
  let isScrolling = false;
  let scrollTimeout;
  let lastScrollTop = 0;
  let anchorBarOriginalTop = 0;
  let isInitialized = false;
  
  function getAnchorBarOriginalTop() {
    if (anchorBarOriginalTop === 0) {
      const rect = anchorBarSection.getBoundingClientRect();
      anchorBarOriginalTop = rect.top + window.pageYOffset;
    }
    return anchorBarOriginalTop;
  }
  
  function handleScroll() {
    console.log('handleScroll');
    if (isScrolling) return;
    isScrolling = true;
    
    const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
    const originalTop = getAnchorBarOriginalTop();
    
    // 添加缓冲区域，避免在边界附近闪烁
    const buffer = 10;
    
    // 如果滚动到子导航的原始位置或更上方，显示主导航，隐藏子导航
    if (scrollTop <= originalTop - buffer) {
      // 显示主导航的三部分
      headerSections.forEach(section => {
        if (section.style.display !== 'block') {
          section.style.display = 'block';
        }
      });
      if (anchorBarParent.classList.contains('is-sticky')) {
        anchorBarParent.classList.remove('is-sticky');
      }
    } else if (scrollTop > originalTop + buffer) {
      // 如果滚动超过子导航原始位置，隐藏主导航，显示子导航
      headerSections.forEach(section => {
        if (section.style.display !== 'none') {
          section.style.display = 'none';
        }
      });
      if (!anchorBarParent.classList.contains('is-sticky')) {
        anchorBarParent.classList.add('is-sticky');
      }
    }
    
    lastScrollTop = scrollTop;
    
    clearTimeout(scrollTimeout);
    scrollTimeout = setTimeout(() => {
      isScrolling = false;
    }, 16); // 约60fps
  }
  
  // 添加滚动监听
  window.addEventListener('scroll', handleScroll, { passive: true });
  
  // 初始化检查
  setTimeout(() => {
    // 只有在页面有滚动距离时才执行handleScroll
    const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
    if (scrollTop > 300) {
      handleScroll();
    }
    isInitialized = true;
  }, 100); 
  
  links.forEach((item) => {
    item.addEventListener('click', (e) => {
      // 如果是第一个链接（回到顶部）
      if (item.getAttribute('data-watch') === 'top') {
        e.preventDefault();
        // 平滑滚动到顶部
        window.scrollTo({
          top: 0,
          behavior: 'smooth'
        });
        return;
      }
      
      if (item.classList.contains('active')) return;
      document.querySelector('.product_anchor_bar_left_item.active').classList.remove('active');
      item.classList.add('active');
    });
  });

  const sectionIds = Array.from(links).map((link) => link.getAttribute('data-watch')).filter(id => id !== 'top');
  let sectionsLoaded = 0;
  let sectionsObserver;
  let sections = [];

  function initializeObserver() {
    console.log('Initializing observer for sections:', sectionIds);
    sectionIds.forEach((sectionId) => {
      waitForElement(`#${sectionId}`, (element) => {
        console.log('Found section element:', sectionId, element);
        sections.push(element);
        sectionsLoaded++;

        if (sectionsLoaded === sectionIds.length) {
          console.log('All sections loaded, starting observer');
          startIntersectionObserver(sections);
        }
      });
    });
  }

  function startIntersectionObserver(sections) {
    console.log('Starting IntersectionObserver with sections:', sections);
    sectionsObserver = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          const targetSection = entry.target;
          const correspondingLink = document.querySelector(
            `.product_anchor_bar_left_item[data-watch="${targetSection.id}"]`
          );
          console.log('IntersectionObserver entry:', {
            target: targetSection.id,
            isIntersecting: entry.isIntersecting,
            correspondingLink: correspondingLink
          });
          if (entry.isIntersecting) {
            // 移除所有链接的active状态
            links.forEach((link) => link.classList.remove('active'));
            // 激活对应的链接
            if (correspondingLink) {
              correspondingLink.classList.add('active');
              console.log('Activated link for section:', targetSection.id);
            }
          }
        });
      },
      {
        root: null,
        threshold: 0.3, // 降低阈值，更容易触发
        rootMargin: '-50px 0px -50px 0px' // 添加边距，避免在边界处频繁切换
      }
    );

    sections.forEach((section) => {
      sectionsObserver.observe(section);
    });
    
    // 监听滚动事件，当页面在顶部时激活第一个链接
    let isAtTop = false;
    let topScrollHandler = () => {
      const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
      const shouldBeAtTop = scrollTop < 100; // 距离顶部100px内认为是在顶部
      
      if (shouldBeAtTop && !isAtTop) {
        // 在顶部，激活第一个链接
        console.log('At top, activating first link');
        links.forEach((link) => link.classList.remove('active'));
        const firstLink = document.querySelector('.product_anchor_bar_left_item[data-watch="top"]');
        if (firstLink) {
          firstLink.classList.add('active');
        }
        isAtTop = true;
      } else if (!shouldBeAtTop && isAtTop) {
        // 不在顶部，取消第一个链接的激活状态
        console.log('Not at top, deactivating first link');
        const firstLink = document.querySelector('.product_anchor_bar_left_item[data-watch="top"]');
        if (firstLink) {
          firstLink.classList.remove('active');
        }
        isAtTop = false;
      }
    };
    
    // 使用节流来优化性能
    let topScrollTimeout;
    window.addEventListener('scroll', () => {
      clearTimeout(topScrollTimeout);
      topScrollTimeout = setTimeout(topScrollHandler, 50);
    }, { passive: true });
  }

  initializeObserver();

  function waitForElement(selector, callback) {
    const element = document.querySelector(selector);
    if (element) {
      callback(element);
      return;
    }

    const observer = new MutationObserver((mutations, obs) => {
      const element = document.querySelector(selector);
      if (element) {
        obs.disconnect();
        callback(element);
      }
    });

    observer.observe(document.body, { childList: true, subtree: true });
  }
</script>

{% schema %}
{
  "name": "product anchor bar",
  "tag": "section",
  "class": "section",
  "disabled_on": {
    "groups": ["header", "footer"]
  },
  "settings": [],
  "blocks": [
    {
      "type": "item",
      "name": "item",
      "settings": [
        {
          "type": "text",
          "id": "title",
          "label": "title"
        },
        {
          "type": "text",
          "id": "anchor_name",
          "label": "anchor name"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "product anchor bar"
    }
  ]
}
{% endschema %}
