{% liquid
  assign sid = section.id
%}

<section id="coupon-ladder-{{ sid }}" class="clv4-wrap">
  <div class="clv4-container">
    <!-- Left -->
    <div class="clv4-left">
      {% if section.settings.kicker != blank %}
        <div class="clv4-kicker">{{ section.settings.kicker }}</div>
      {% endif %}

      {% if section.settings.title != blank %}
        <h2 class="clv4-title">{{ section.settings.title }}</h2>
      {% endif %}

      {% if section.settings.desc != blank %}
        <div class="clv4-desc rte">{{ section.settings.desc }}</div>
      {% endif %}

      <!-- Regeln accordion -->
      <button class="clv4-rules"
              data-clv4-toggle-rules
              aria-expanded="false">
        {{ section.settings.rules_text }}
      </button>

      <div class="clv4-rules-accordion" hidden>
        <div class="clv4-rules-accordion-inner rte">
          {{ section.settings.rules_content }}
        </div>
      </div>

      <div class="clv4-time">
        <div class="clv4-time-row">
          <span>Start:</span>
          <span data-clv4-start-text>--</span>
        </div>
        <div class="clv4-time-row">
          <span>Ende:</span>
          <span data-clv4-end-text>--</span>
        </div>
      </div>

      <div class="clv4-countdown">
        <div class="clv4-cd-box"><b data-dd>00</b><span>Tage</span></div>
        <div class="clv4-cd-box"><b data-hh>00</b><span>Std</span></div>
        <div class="clv4-cd-box"><b data-mm>00</b><span>Min</span></div>
        <div class="clv4-cd-box"><b data-ss>00</b><span>Sek</span></div>
      </div>
    </div>

    <!-- Right -->
    <div class="clv4-right">
      <div class="clv4-ladder">
        {% for block in section.blocks %}
          <div class="clv4-card clv4-level-{{ forloop.index }}"
               data-clv4-card
               data-percent="{{ block.settings.percent }}"
               data-code="{{ block.settings.coupon_code }}"
               data-redirect="{{ block.settings.redirect_url }}"
               data-total="{{ block.settings.total_qty }}"
               data-weight="{{ block.settings.speed_weight }}">

            <div class="clv4-card-top">
              <div class="clv4-percent">{{ block.settings.percent }}</div>

              <div class="clv4-qty">
                Qty:
                <b data-clv4-qty>--</b>
                |
                <span data-clv4-left>--</span> left
              </div>

              <div class="clv4-bar">
                <div class="clv4-bar-in"></div>
              </div>
            </div>

            <button class="clv4-btn" data-clv4-open-coupon>
              {{ section.settings.claim_button_text }}
            </button>
          </div>
        {% endfor %}
      </div>
    </div>
  </div>

  <!-- Coupon Modal -->
  <div class="clv4-modal" hidden>
    <div class="clv4-backdrop"></div>
    <div class="clv4-panel">
      <button class="clv4-x">×</button>
      <div class="clv4-panel-title">{{ section.settings.coupon_modal_title }}</div>
      <div class="clv4-panel-sub" data-modal-percent></div>

      <div class="clv4-codebox">
        <code data-modal-code>----</code>
        <button data-copy>Copy</button>
      </div>

      <a class="clv4-cta" data-modal-cta>
        {{ section.settings.coupon_modal_cta_text }}
      </a>

      {% if section.settings.coupon_modal_hint != blank %}
        <div class="clv4-hint">{{ section.settings.coupon_modal_hint }}</div>
      {% endif %}
    </div>
  </div>
</section>

<style>
#coupon-ladder-{{ sid }}{
  background: {{ section.settings.bg_color }};
  color:#fff;
  padding:48px 0;
}
#coupon-ladder-{{ sid }} .clv4-container{
  max-width:1240px;
  margin:auto;
  display:grid;
  grid-template-columns:1.1fr 1.9fr;
  gap:32px;
}
#coupon-ladder-{{ sid }} .clv4-ladder{
  display:flex;
  align-items:flex-end;
  gap:16px;
}
#coupon-ladder-{{ sid }} .clv4-card{
  flex:1;
  background: {{ section.settings.card_bg }};
  border-radius:18px;
  padding:16px;
  display:flex;
  flex-direction:column;
}
#coupon-ladder-{{ sid }} .clv4-card-top{
  display:flex;
  flex-direction:column;
}
#coupon-ladder-{{ sid }} .clv4-percent{
  font-weight:900;
  margin-bottom:10px;
}
#coupon-ladder-{{ sid }} .clv4-level-1 .clv4-percent{font-size:44px!important}
#coupon-ladder-{{ sid }} .clv4-level-2 .clv4-percent{font-size:36px!important}
#coupon-ladder-{{ sid }} .clv4-level-3 .clv4-percent{font-size:30px!important}
#coupon-ladder-{{ sid }} .clv4-level-4 .clv4-percent{font-size:26px!important}

#coupon-ladder-{{ sid }} .clv4-bar{
  height:6px;
  background:rgba(255,255,255,.2);
  margin-top:auto;
  border-radius:99px;
  overflow:hidden;
}
#coupon-ladder-{{ sid }} .clv4-bar-in{
  height:100%;
  background: {{ section.settings.accent_color }};
  width:0;
}
#coupon-ladder-{{ sid }} .clv4-btn{
  margin-top:14px;
  border-radius:99px;
  padding:12px;
  font-weight:900;
  cursor:pointer;
}
#coupon-ladder-{{ sid }} .clv4-btn.is-disabled{
  background:#777;
  color:#444;
  cursor:not-allowed;
}

@media(max-width:900px){
  #coupon-ladder-{{ sid }} .clv4-container{grid-template-columns:1fr}
  #coupon-ladder-{{ sid }} .clv4-ladder{flex-direction:column}
}
</style>

<script>
(function(){
  const root=document.getElementById('coupon-ladder-{{ sid }}');
  if(!root)return;

  const start=new Date('{{ section.settings.start_at }}');
  const endRaw='{{ section.settings.end_at }}';
  const end=endRaw && endRaw!=='-' ? new Date(endRaw) : new Date(start.getTime()+{{ section.settings.duration_hours }}*3600*1000);

  const modal=root.querySelector('.clv4-modal');
  const mCode=root.querySelector('[data-modal-code]');
  const mPercent=root.querySelector('[data-modal-percent]');
  const mCta=root.querySelector('[data-modal-cta]');

  function update(){
    const now=new Date();

    root.querySelectorAll('[data-clv4-card]').forEach(card=>{
      const total=+card.dataset.total;
      const weight=+card.dataset.weight||100;
      const btn=card.querySelector('.clv4-btn');
      const bar=card.querySelector('.clv4-bar-in');

      let progress=Math.min(1,Math.max(0,(now-start)/(end-start)));
      let dep=Math.min(1,progress*(100/weight));
      let left=Math.max(0,Math.round(total*(1-dep)));

      card.querySelector('[data-clv4-qty]').textContent=total;
      card.querySelector('[data-clv4-left]').textContent=left;
      bar.style.width=(left/total*100)+'%';

      if(now<start || now>end){
        btn.classList.add('is-disabled');
        btn.disabled=true;
      }else{
        btn.classList.remove('is-disabled');
        btn.disabled=false;
      }
    });
  }

  root.querySelectorAll('[data-clv4-open-coupon]').forEach(btn=>{
    btn.onclick=e=>{
      if(btn.disabled)return;
      const card=e.target.closest('[data-clv4-card]');
      modal.hidden=false;
      mCode.textContent=card.dataset.code;
      mPercent.textContent='Rabatt '+card.dataset.percent;
      mCta.href='/discount/'+card.dataset.code+'?redirect='+card.dataset.redirect;
    };
  });

  root.querySelector('.clv4-x').onclick=()=>modal.hidden=true;
  root.querySelector('.clv4-backdrop').onclick=()=>modal.hidden=true;

  update();
  setInterval(update,30000);
})();
</script>

{% schema %}
{
  "name": "Coupon Ladder Final",
  "settings": [
    { "type":"text","id":"kicker","label":"Kicker","default":"Schnell sein – Codes sichern & sparen!" },
    { "type":"text","id":"title","label":"Title","default":"Je schneller, desto mehr Rabatt" },
    { "type":"richtext","id":"desc","label":"Description","default":"<p>Nur für kurze Zeit.</p>" },
    { "type":"text","id":"rules_text","label":"Regeln text","default":"Regeln >" },
    { "type":"richtext","id":"rules_content","label":"Regeln content","default":"<p>Nur solange der Vorrat reicht.</p>" },
    { "type":"text","id":"start_at","label":"Start time","default":"2026-01-11 23:00" },
    { "type":"text","id":"end_at","label":"End time","default":"-" },
    { "type":"number","id":"duration_hours","label":"Duration hours","default":48 },
    { "type":"text","id":"claim_button_text","label":"Button text","default":"Gutschein sichern" },
    { "type":"text","id":"coupon_modal_title","label":"Modal title","default":"Gutschein sichern" },
    { "type":"text","id":"coupon_modal_cta_text","label":"Modal CTA","default":"Jetzt shoppen" },
    { "type":"text","id":"coupon_modal_hint","label":"Hint","default":"Rabatt wird automatisch angewendet" },
    { "type":"color","id":"bg_color","label":"BG","default":"#2a0d0d" },
    { "type":"color","id":"card_bg","label":"Card BG","default":"#1d6a4c" },
    { "type":"color","id":"accent_color","label":"Accent","default":"#ff3b30" }
  ],
  "blocks":[
    {
      "type":"tier",
      "name":"Tier",
      "settings":[
        { "type":"text","id":"percent","label":"Percent","default":"-50%" },
        { "type":"number","id":"total_qty","label":"Total","default":100 },
        { "type":"range","id":"speed_weight","label":"Speed","min":10,"max":300,"step":5,"default":100 },
        { "type":"text","id":"coupon_code","label":"Code","default":"WEIHNACHTEN" },
        { "type":"text","id":"redirect_url","label":"Redirect","default":"/collections/all" }
      ]
    }
  ],
  "presets":[{"name":"Coupon Ladder Final"}]
}
{% endschema %}
