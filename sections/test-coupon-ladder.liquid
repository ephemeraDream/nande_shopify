{% liquid
  assign sid = section.id
%}

<section id="coupon-ladder-{{ sid }}" class="clv4-wrap">
  <div class="clv4-container">
    <!-- Left -->
    <div class="clv4-left">
      {% if section.settings.kicker != blank %}
        <div class="clv4-kicker">{{ section.settings.kicker }}</div>
      {% endif %}

      {% if section.settings.title != blank %}
        <h2 class="clv4-title">{{ section.settings.title }}</h2>
      {% endif %}

      {% if section.settings.desc != blank %}
        <div class="clv4-desc rte">
          {{ section.settings.desc }}
        </div>
      {% endif %}

      <!-- Regeln: 改为弹窗按钮 -->
      <button type="button"
              class="clv4-rules"
              data-clv4-open-rules
              aria-haspopup="dialog">
        {{ section.settings.rules_text }}
      </button>

      <div class="clv4-time">
        <div class="clv4-time-row">
          <span class="clv4-time-label">Start:</span>
          <span class="clv4-time-value" data-clv4-start-text>--</span>
        </div>
        <div class="clv4-time-row">
          <span class="clv4-time-label">Ende:</span>
          <span class="clv4-time-value" data-clv4-end-text>--</span>
        </div>
      </div>

      <div class="clv4-countdown" aria-live="polite">
        <div class="clv4-cd-label">{{ section.settings.countdown_label }}</div>
        <div class="clv4-cd-boxes">
          <div class="clv4-cd-box"><b data-clv4-dd>--</b><span>Tage</span></div>
          <div class="clv4-cd-box"><b data-clv4-hh>--</b><span>Stunden</span></div>
          <div class="clv4-cd-box"><b data-clv4-mm>--</b><span>Minuten</span></div>
          <div class="clv4-cd-box"><b data-clv4-ss>--</b><span>Sekunden</span></div>
        </div>
      </div>
    </div>

    <!-- Right -->
    <div class="clv4-right">
      <div class="clv4-ladder" role="list">
        {% for block in section.blocks %}
          {% liquid
            assign pct = block.settings.percent | strip
            assign code = block.settings.coupon_code | strip
            assign redirect = block.settings.redirect_url | strip
            assign total = block.settings.total_qty
            assign w = block.settings.speed_weight
          %}
          <div class="clv4-card clv4-level-{{ forloop.index }}"
               role="listitem"
               data-clv4-card
               data-clv4-percent="{{ pct }}"
               data-clv4-code="{{ code | escape }}"
               data-clv4-redirect="{{ redirect | escape }}"
               data-clv4-total="{{ total }}"
               data-clv4-weight="{{ w }}">
            <div class="clv4-card-top">
              <div class="clv4-percent">{{ pct }}</div>

              <div class="clv4-qty">
                <span>Qty:</span>
                <b data-clv4-qty>--</b>
                <span>|</span>
                <span data-clv4-left>--</span>
                <span>left</span>
              </div>

              <div class="clv4-bar" aria-hidden="true">
                <div class="clv4-bar-in" data-clv4-bar style="width:0%"></div>
              </div>
            </div>

            <button type="button" class="clv4-btn" data-clv4-open-coupon>
              <span class="clv4-btn-text">{{ section.settings.claim_button_text }}</span>
            </button>
          </div>
        {% endfor %}
      </div>
    </div>
  </div>

  <!-- Rules Modal - 新增规则弹窗 -->
  <div class="clv4-modal clv4-rules-modal" data-clv4-rules-modal hidden>
    <div class="clv4-backdrop" data-clv4-close-rules></div>
    <div class="clv4-panel" role="dialog" aria-modal="true" aria-label="Regeln">
      <button class="clv4-x" type="button" aria-label="Close" data-clv4-close-rules>×</button>

      <div class="clv4-panel-head">
        <div class="clv4-panel-title">{{ section.settings.rules_text | replace: '>', '' | strip }}</div>
      </div>

      <div class="clv4-rules-content rte">
        {{ section.settings.rules_content }}
      </div>
    </div>
  </div>

  <!-- Coupon Modal -->
  <div class="clv4-modal" data-clv4-coupon-modal hidden>
    <div class="clv4-backdrop" data-clv4-close-coupon></div>
    <div class="clv4-panel" role="dialog" aria-modal="true" aria-label="Gutschein">
      <button class="clv4-x" type="button" aria-label="Close" data-clv4-close-coupon>×</button>

      <div class="clv4-panel-head">
        <div class="clv4-panel-title">{{ section.settings.coupon_modal_title }}</div>
        <div class="clv4-panel-sub" data-clv4-modal-sub>Rabatt: --</div>
        <div class="clv4-modal-countdown" data-clv4-modal-countdown>Endet in --</div>
      </div>

      <div class="clv4-codebox">
        <div class="clv4-code-label">{{ section.settings.code_label }}</div>
        <div class="clv4-code-row">
          <code class="clv4-code" data-clv4-modal-code>--</code>
          <button type="button" class="clv4-copy" data-clv4-copy>Copy</button>
        </div>
      </div>

      <a class="clv4-cta" data-clv4-modal-cta href="#">
        {{ section.settings.coupon_modal_cta_text }}
      </a>

      {% if section.settings.coupon_modal_hint != blank %}
        <div class="clv4-hint">{{ section.settings.coupon_modal_hint }}</div>
      {% endif %}
    </div>
  </div>
</section>

<style>
  #coupon-ladder-{{ sid }}{
    --bg: {{ section.settings.bg_color }};
    --card: {{ section.settings.card_bg }};
    --text: {{ section.settings.text_color }};
    --muted: rgba(255,255,255,.80);
    --accent: {{ section.settings.accent_color }};
    --radius: 18px;

    color: var(--text);
    background: var(--bg);
    padding: 44px 0;
  }

  #coupon-ladder-{{ sid }} .clv4-container{
    width: min(1240px, calc(100% - 40px));
    margin: 0 auto;
    display: grid;
    grid-template-columns: 1.1fr 1.9fr;
    gap: 28px;
    align-items: center;
  }

  #coupon-ladder-{{ sid }} .clv4-kicker{ color:#fff; opacity:.92; font-weight:700; margin-bottom:10px; }
  #coupon-ladder-{{ sid }} .clv4-title{
    color:#fff;
    font-size: clamp(26px, 3.2vw, 42px);
    line-height: 1.12;
    margin: 0 0 14px;
    font-weight: 900;
  }
  #coupon-ladder-{{ sid }} .clv4-desc{ color: var(--muted); font-size: 14px; line-height: 1.7; }

  #coupon-ladder-{{ sid }} .clv4-rules{
    margin-top: 10px;
    padding: 0;
    border: 0;
    background: transparent;
    color: var(--accent);
    font-weight: 900;
    text-decoration: underline;
    cursor: pointer;
  }

  #coupon-ladder-{{ sid }} .clv4-time{
    margin-top: 14px;
    padding-top: 14px;
    border-top: 1px solid rgba(255,255,255,.14);
  }
  #coupon-ladder-{{ sid }} .clv4-time-row{ display:flex; gap:10px; font-size: 13px; color: var(--muted); margin: 4px 0; }
  #coupon-ladder-{{ sid }} .clv4-time-label{ min-width: 44px; opacity:.95; }

  #coupon-ladder-{{ sid }} .clv4-cd-boxes{
    display:flex;
    gap:10px;
    flex-wrap: nowrap;
    overflow:hidden;
  }
  #coupon-ladder-{{ sid }} .clv4-cd-box{
    flex:0 0 auto;
    min-width: 76px;
    background: rgba(0,0,0,.24);
    border: 1px solid rgba(255,255,255,.10);
    border-radius: 12px;
    padding: 10px 10px;
    text-align:center;
  }
  #coupon-ladder-{{ sid }} .clv4-cd-label{ font-size: 13px; color: var(--muted); margin: 14px 0 8px; }
  #coupon-ladder-{{ sid }} .clv4-cd-box b{ display:block; font-size: 18px; letter-spacing:.5px; color:#fff; }
  #coupon-ladder-{{ sid }} .clv4-cd-box span{ font-size: 12px; color: var(--muted); }

  #coupon-ladder-{{ sid }} .clv4-ladder{
    display:flex;
    align-items:flex-end;
    gap: 14px;
    width: 100%;
  }

  #coupon-ladder-{{ sid }} .clv4-card{
    flex: 1;
    min-width: 0;
    background: var(--card);
    border: 1px solid rgba(255,255,255,.10);
    border-radius: var(--radius);
    padding: 16px;
    box-shadow: 0 12px 30px rgba(0,0,0,.22);
    display: grid;
    grid-template-rows: 1fr auto;
    gap: 14px;
    overflow: visible;
  }

  #coupon-ladder-{{ sid }} .clv4-percent{
    font-size: clamp(22px, 2.2vw, 44px);
    font-weight: 900;
    margin-bottom: 10px;
    color:#fff;
  }
  .clv4-level-1 .clv4-percent{ font-size: 44px !important; }
  .clv4-level-2 .clv4-percent{ font-size: 36px !important; }
  .clv4-level-3 .clv4-percent{ font-size: 30px !important; }
  .clv4-level-4 .clv4-percent{ font-size: 26px !important; }

  #coupon-ladder-{{ sid }} .clv4-qty{
    font-size: 13px;
    color: rgba(255,255,255,.72);
    display:flex;
    gap:6px;
    align-items: baseline;
  }
  #coupon-ladder-{{ sid }} .clv4-qty b{ color:#fff; font-size:14px; }

  #coupon-ladder-{{ sid }} .clv4-bar{
    height: 6px;
    border-radius: 999px;
    background: rgba(255,255,255,.18);
    margin-top: auto;
    overflow:hidden;
  }
  #coupon-ladder-{{ sid }} .clv4-bar-in{
    height:100%;
    background: var(--accent);
    width: 0%;
    transition: width .35s ease;
  }

  #coupon-ladder-{{ sid }} .clv4-btn{
    width: 100%;
    border: 0;
    border-radius: 999px;
    padding: 12px 12px;
    background: #fff;
    color: #111;
    cursor: pointer;
    min-height: 46px;
    display:flex;
    align-items:center;
    justify-content:center;
  }
  #coupon-ladder-{{ sid }} .clv4-btn.is-disabled{
    background: rgba(255,255,255,.35) !important;
    color: rgba(0,0,0,.55) !important;
    cursor: not-allowed !important;
    pointer-events: none !important;
    opacity: .75;
  }
  #coupon-ladder-{{ sid }} .clv4-btn-text{
    font-weight: 900;
    font-size: clamp(12px, 1.05vw, 16px);
    line-height: 1;
    white-space: nowrap;
  }

  #coupon-ladder-{{ sid }} .clv4-level-1{ min-height: 230px; }
  #coupon-ladder-{{ sid }} .clv4-level-2{ min-height: 210px; }
  #coupon-ladder-{{ sid }} .clv4-level-3{ min-height: 195px; }
  #coupon-ladder-{{ sid }} .clv4-level-4{ min-height: 182px; }
  #coupon-ladder-{{ sid }} .clv4-level-5{ min-height: 172px; }
  #coupon-ladder-{{ sid }} .clv4-level-6{ min-height: 164px; }

  #coupon-ladder-{{ sid }} .clv4-modal[hidden]{ display:none; }
  #coupon-ladder-{{ sid }} .clv4-modal{
    position:fixed; inset:0; z-index:9999;
    display:flex; align-items:center; justify-content:center;
  }
  #coupon-ladder-{{ sid }} .clv4-backdrop{
    position:absolute; inset:0;
    background: rgba(0,0,0,.68);
    backdrop-filter: blur(2px);
  }
  #coupon-ladder-{{ sid }} .clv4-panel{
    position:relative;
    width: min(460px, calc(100% - 28px));
    background:#0b0c0f; color:#fff;
    border:1px solid rgba(255,255,255,.16);
    border-radius:18px;
    padding:20px;
    box-shadow: 0 26px 80px rgba(0,0,0,.55);
    max-height: min(76vh, 680px);
    overflow:auto;
  }
  #coupon-ladder-{{ sid }} .clv4-x{
    position:absolute; top:10px; right:12px;
    width:38px; height:38px;
    border-radius:12px;
    border:1px solid rgba(255,255,255,.18);
    background: rgba(255,255,255,.06);
    color:#fff; font-size:22px; line-height:34px;
    cursor:pointer;
  }
  #coupon-ladder-{{ sid }} .clv4-panel-head{
    padding-bottom:12px;
    border-bottom:1px solid rgba(255,255,255,.10);
    margin-bottom:14px;
  }
  #coupon-ladder-{{ sid }} .clv4-panel-title{ font-weight:900; font-size:18px; margin-top:2px; }
  #coupon-ladder-{{ sid }} .clv4-panel-sub{ margin-top:6px; color:rgba(255,255,255,.78); font-size:13px; }
  #coupon-ladder-{{ sid }} .clv4-modal-countdown{ margin-top:6px; font-size:13px; color:rgba(255,255,255,.75); }

  #coupon-ladder-{{ sid }} .clv4-rules-content{
    color: rgba(255,255,255,.88);
    font-size: 14px;
    line-height: 1.7;
  }

  #coupon-ladder-{{ sid }} .clv4-codebox{
    background: rgba(255,255,255,.05);
    border:1px solid rgba(255,255,255,.12);
    border-radius:14px;
    padding:14px;
  }
  #coupon-ladder-{{ sid }} .clv4-code-label{ font-size:12px; color:rgba(255,255,255,.70); margin-bottom:10px; }
  #coupon-ladder-{{ sid }} .clv4-code-row{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
  #coupon-ladder-{{ sid }} .clv4-code{ font-size:16px; font-weight:900; letter-spacing:1px; color:#fff; }
  #coupon-ladder-{{ sid }} .clv4-copy{
    border:0; border-radius:12px;
    padding:10px 12px;
    background: rgba(255,255,255,.92);
    color:#111; font-weight:900;
    cursor:pointer; white-space:nowrap;
  }
  #coupon-ladder-{{ sid }} .clv4-cta{
    display:block; margin-top:14px;
    text-align:center;
    border-radius:999px;
    padding:13px 14px;
    font-weight:900;
    background: var(--accent);
    color:#111; text-decoration:none;
  }
  #coupon-ladder-{{ sid }} .clv4-hint{ margin-top:10px; font-size:12px; color:rgba(255,255,255,.65); line-height:1.6; }

  @media (max-width: 900px){
    #coupon-ladder-{{ sid }} .clv4-container{ grid-template-columns:1fr; gap:18px; align-items:start; }
    #coupon-ladder-{{ sid }} .clv4-ladder{ flex-direction:column; align-items:stretch; gap:12px; }
    #coupon-ladder-{{ sid }} .clv4-card{ min-height: unset !important; }
    #coupon-ladder-{{ sid }} .clv4-cd-boxes{ flex-wrap: wrap; }
  }
</style>

<script>
(function(){
  var root = document.getElementById('coupon-ladder-{{ sid }}');
  if(!root) return;

  var startAt = {{ section.settings.start_at | json }};
  var endAt = {{ section.settings.end_at | json }};
  var durationHours = Number({{ section.settings.duration_hours | json }}) || 48;

  var fastPart = Number({{ section.settings.fast_part_percent | json }});
  if (isNaN(fastPart)) fastPart = 70;
  fastPart = Math.max(0, Math.min(100, fastPart)) / 100;

  function pad2(n){ return String(n).padStart(2,'0'); }
  function clamp01(x){ return Math.max(0, Math.min(1, x)); }

  function safeDate(s){
    if(!s) return null;
    var str = String(s).trim();
    if(!str || str === '-' || str.toLowerCase() === 'null') return null;
    var d = new Date(str);
    if(!isNaN(d.getTime())) return d;
    var t = str.replace(' ', 'T');
    d = new Date(t);
    if(!isNaN(d.getTime())) return d;
    return null;
  }
  
  function fmt(d){
    if(!d) return '--';
    return pad2(d.getDate()) + '.' + pad2(d.getMonth()+1) + '.' + d.getFullYear() + ' ' + pad2(d.getHours()) + ':' + pad2(d.getMinutes());
  }

  function easeOutQuad(t){ return 1 - (1 - t) * (1 - t); }
  function easeInQuad(t){ return t * t; }

  var startD = safeDate(startAt);
  var endD = safeDate(endAt);

  if(startD && !endD){
    endD = new Date(startD.getTime() + durationHours * 3600 * 1000);
  }

  var startTextEl = root.querySelector('[data-clv4-start-text]');
  var endTextEl = root.querySelector('[data-clv4-end-text]');
  if(startTextEl) startTextEl.textContent = fmt(startD);
  if(endTextEl) endTextEl.textContent = fmt(endD);

  function getCampaignState(){
    var now = new Date();
    if(!startD || !endD) return 'invalid';
    if(now < startD) return 'before';
    if(now >= endD) return 'after';
    return 'active';
  }

  var ddEl = root.querySelector('[data-clv4-dd]');
  var hhEl = root.querySelector('[data-clv4-hh]');
  var mmEl = root.querySelector('[data-clv4-mm]');
  var ssEl = root.querySelector('[data-clv4-ss]');

  function updateCountdown(){
    if(!ddEl || !hhEl || !mmEl || !ssEl) return;
    if(!endD || getCampaignState() === 'invalid'){
      ddEl.textContent='00'; hhEl.textContent='00'; mmEl.textContent='00'; ssEl.textContent='00';
      return;
    }
    var now = new Date();
    var diff = Math.max(0, endD.getTime() - now.getTime());
    var sec = Math.floor(diff/1000);
    var dd = Math.floor(sec/86400); sec -= dd*86400;
    var hh = Math.floor(sec/3600);  sec -= hh*3600;
    var mm = Math.floor(sec/60);    sec -= mm*60;
    ddEl.textContent = pad2(dd);
    hhEl.textContent = pad2(hh);
    mmEl.textContent = pad2(mm);
    ssEl.textContent = pad2(sec);
  }

  function depletionBase(progress01){
    if(progress01 <= 0) return 0;
    if(progress01 >= 1) return 1;
    if(progress01 < 0.5){
      var t = progress01 / 0.5;
      return fastPart * easeOutQuad(t);
    }else{
      var t2 = (progress01 - 0.5) / 0.5;
      return fastPart + (1 - fastPart) * easeInQuad(t2);
    }
  }

  function setBtnDisabled(btn, disabled){
    if(!btn) return;
    if(disabled){
      btn.classList.add('is-disabled');
      btn.setAttribute('aria-disabled', 'true');
      btn.setAttribute('tabindex', '-1');
    }else{
      btn.classList.remove('is-disabled');
      btn.removeAttribute('aria-disabled');
      btn.removeAttribute('tabindex');
    }
  }

  function applySimulatedQuota(card){
    var total = Number(card.getAttribute('data-clv4-total') || 0);
    if(total < 0) total = 0;
    var qtyEl = card.querySelector('[data-clv4-qty]');
    var leftEl = card.querySelector('[data-clv4-left]');
    var barEl = card.querySelector('[data-clv4-bar]');
    var btn = card.querySelector('[data-clv4-open-coupon]');
    var state = getCampaignState();
    var now = new Date();
    if(qtyEl) qtyEl.textContent = String(total);
    if(state === 'before'){
      if(leftEl) leftEl.textContent = String(total);
      if(barEl) barEl.style.width = '100%';
      setBtnDisabled(btn, true);
      return;
    }
    if(state === 'after' || state === 'invalid'){
      if(leftEl) leftEl.textContent = '0';
      if(barEl) barEl.style.width = '0%';
      setBtnDisabled(btn, true);
      return;
    }
    var progress = clamp01((now.getTime() - startD.getTime()) / (endD.getTime() - startD.getTime()));
    var baseDep = depletionBase(progress);
    var weight = Number(card.getAttribute('data-clv4-weight') || 100);
    if(isNaN(weight)) weight = 100;
    weight = Math.max(10, Math.min(300, weight));
    var speedFactor = 100 / weight;
    var dep = Math.min(1, baseDep * speedFactor);
    var used = Math.round(total * dep);
    var left = Math.max(0, total - used);
    var pctLeft = (total > 0) ? (left / total * 100) : 0;
    if(leftEl) leftEl.textContent = String(left);
    if(barEl) barEl.style.width = Math.max(0, Math.min(100, pctLeft)) + '%';
    setBtnDisabled(btn, left <= 0);
  }

  function updateQuotaAll(){
    root.querySelectorAll('[data-clv4-card]').forEach(applySimulatedQuota);
  }

  function lockScroll(on){ document.documentElement.style.overflow = on ? 'hidden' : ''; }

  var rulesModal = root.querySelector('[data-clv4-rules-modal]');
  var rulesOpenBtn = root.querySelector('[data-clv4-open-rules]');
  
  function openRulesModal(){
    if(!rulesModal) return;
    rulesModal.hidden = false;
    lockScroll(true);
  }

  function closeRulesModal(){
    if(!rulesModal) return;
    rulesModal.hidden = true;
    lockScroll(false);
  }

  if(rulesOpenBtn){
    rulesOpenBtn.addEventListener('click', openRulesModal);
  }

  root.querySelectorAll('[data-clv4-close-rules]').forEach(function(el){
    el.addEventListener('click', closeRulesModal);
  });

  var couponModal = root.querySelector('[data-clv4-coupon-modal]');
  var modalSub = root.querySelector('[data-clv4-modal-sub]');
  var modalCodeEl = root.querySelector('[data-clv4-modal-code]');
  var modalCta = root.querySelector('[data-clv4-modal-cta]');
  var copyBtn = root.querySelector('[data-clv4-copy]');
  var modalCdEl = root.querySelector('[data-clv4-modal-countdown]');

  function updateModalCountdown(){
    if(!modalCdEl) return;
    if(!endD || getCampaignState() === 'invalid'){
      modalCdEl.textContent = 'Endet in --';
      return;
    }
    var now = new Date();
    var diff = Math.max(0, endD.getTime() - now.getTime());
    var sec = Math.floor(diff/1000);
    var d = Math.floor(sec/86400); sec -= d*86400;
    var h = Math.floor(sec/3600);  sec -= h*3600;
    var m = Math.floor(sec/60);    sec -= m*60;
    modalCdEl.textContent = 'Endet in ' + d + 'd ' + h + 'h ' + m + 'm ' + sec + 's';
  }

  function openCouponModal(card){
    if(!couponModal) return;
    if(getCampaignState() !== 'active') return;
    var btn = card.querySelector('[data-clv4-open-coupon]');
    if(btn && btn.classList.contains('is-disabled')) return;
    var percent = card.getAttribute('data-clv4-percent') || '';
    var code = card.getAttribute('data-clv4-code') || '';
    var redirect = card.getAttribute('data-clv4-redirect') || '/';
    if(modalSub) modalSub.textContent = percent ? ('Rabatt: ' + percent) : 'Rabatt';
    if(modalCodeEl) modalCodeEl.textContent = code ? code : '--';
    if(modalCta) modalCta.href = '/discount/' + encodeURIComponent(code) + '?redirect=' + encodeURIComponent(redirect);
    updateModalCountdown();
    couponModal.hidden = false;
    lockScroll(true);
  }

  function closeCouponModal(){
    if(!couponModal) return;
    couponModal.hidden = true;
    lockScroll(false);
  }

  root.querySelectorAll('[data-clv4-open-coupon]').forEach(function(btn){
    btn.addEventListener('click', function(e){
      if(btn.classList.contains('is-disabled')){
        e.preventDefault();
        return;
      }
      var card = e.currentTarget.closest('[data-clv4-card]');
      if(card) openCouponModal(card);
    });
  });

  root.querySelectorAll('[data-clv4-close-coupon]').forEach(function(el){
    el.addEventListener('click', closeCouponModal);
  });

  document.addEventListener('keydown', function(e){
    if(e.key === 'Escape'){
      if(couponModal && !couponModal.hidden) closeCouponModal();
      if(rulesModal && !rulesModal.hidden) closeRulesModal();
    }
  });

  if(copyBtn){
    copyBtn.addEventListener('click', function(){
      var text = (modalCodeEl && modalCodeEl.textContent) ? modalCodeEl.textContent.trim() : '';
      if(!text || text === '--') return;
      function flash(){
        copyBtn.textContent = 'Copied';
        setTimeout(function(){ copyBtn.textContent = 'Copy'; }, 900);
      }
      if(navigator.clipboard && navigator.clipboard.writeText){
        navigator.clipboard.writeText(text).then(flash).catch(function(){});
      }else{
        var ta = document.createElement