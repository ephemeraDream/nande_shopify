{{ 'section-activity-reorder.css' | asset_url | stylesheet_tag }}

<div class="activity_reorder_section padding-sider" id="{{ section.settings.specId }}">
  <div class="activity_reorder">
    <h2 class="activity_reorder_title">{{ section.settings.title }}</h2>
    <div class="activity_reorder_text">{{ section.settings.text }}</div>
    <div class="activity_reorder_contain">
      <div class="activity_reorder_contain_left">
        <div class="activity_reorder_contain_left_title">
          {{ 'common.be_among_the_first' | t -}}
          <span class="activity_reorder_contain_left_title_num">{{ section.settings.quota }}</span>
          {{- 'common.customers_who' | t -}}
          <span class="activity_reorder_contain_left_title_num">{{ section.settings.reorder_proportion }}</span>
          {{- 'common.get_cashback' | t }}
        </div>
        <div class="activity_reorder_contain_left_text">{{ section.settings.explanation }}</div>
        <div class="activity_reorder_contain_left_btnline">
          
          <!-- 规则按钮 (Regulate Button) - 保持不变，用于弹出规则弹窗 -->
          <div class="activity_reorder_contain_left_btn rule-trigger">
            {{ 'common.regulate' | t }}
            {{ 'icon-right-arrow.svg' | inline_asset_content }}
          </div>

          <div class="common_modal">
            <div class="common_modal_contain">
              <div class="common_modal_head">
                <span>{{ 'common.regulate' | t }}</span>
                <div class="common_modal_close">{{- 'icon-close.svg' | inline_asset_content -}}</div>
              </div>
              <div class="common_modal_body">
                {{ section.settings.rule }}
              </div>
            </div>
          </div>

          <!-- 第二个按钮 (Gewinnerliste Button) - 修改为触发 Omnisend 弹窗 -->
          {% if section.settings.btn_two != blank %}
            <a 
              class="activity_reorder_contain_left_btntwo omnisend-popup-trigger" 
              href="#" 
              id="omnisend-trigger-btn"
              data-omnisend-id="6905740fb127c51a5d21d0dc"
            >
              {{- section.settings.btn_two -}}
            </a>
          {% endif %}
        </div>
      </div>
      <img src="{{ section.settings.right_img | image_url }}" class="activity_reorder_contain_img">
    </div>
  </div>
</div>

<script>
  (() => {
    // 规则弹窗逻辑 (Regulate Button Logic)
    const rule_btn = document.querySelector('.activity_reorder_contain_left_btn.rule-trigger');
    if (rule_btn) {
      // 保持原有的规则弹窗逻辑不变
      rule_btn.addEventListener('click', () => {
        const parent = rule_btn.closest('.activity_reorder_contain_left_btnline');
        const modal = parent.querySelector('.common_modal');
        const originalParent = modal.parentElement;
        const nextSibling = modal.nextElementSibling;
        
        // 将弹窗移动到 body
        document.body.appendChild(modal);
        modal.style.display = 'block';
        document.body.style.overflowY = 'hidden';

        const closeModal = () => {
            modal.style.display = 'none';
            document.body.style.overflowY = 'auto';

            // 恢复弹窗到原始位置
            if (nextSibling) {
                originalParent.insertBefore(modal, nextSibling);
            } else {
                originalParent.appendChild(modal);
            }
        };

        modal.querySelector('.common_modal_close').addEventListener('click', closeModal);

        modal.addEventListener('click', (e) => {
          if (e.target === modal) closeModal();
        });
      });
    }

    // Omnisend 触发逻辑 (Gewinnerliste Button Logic)
    const omnisendBtn = document.getElementById('omnisend-trigger-btn');
    if (omnisendBtn) {
      omnisendBtn.addEventListener('click', (e) => {
        e.preventDefault(); // 阻止链接跳转

        const formId = omnisendBtn.getAttribute('data-omnisend-id');

        if (formId) {
          // 确保 Omnisend 队列存在
          window.omnisend = window.omnisend || [];
          
          // 执行触发 Omnisend 弹窗的代码
          window.omnisend.push(['openForm', formId]);
        } else {
          console.error("Omnisend Form ID not found on the button.");
        }
      });
    }

  })();
</script>

{% schema %}
{
  "name": "activity reorder",
  "tag": "section",
  "class": "section",
  "disabled_on": {
    "groups": ["header", "footer"]
  },
  "settings": [
    {
      "type": "text",
      "id": "specId",
      "label": "specId"
    },
    {
      "type": "richtext",
      "id": "title",
      "label": "title"
    },
    {
      "type": "richtext",
      "id": "text",
      "label": "text"
    },
    {
      "type": "text",
      "id": "quota",
      "label": "quota"
    },
    {
      "type": "text",
      "id": "reorder_proportion",
      "label": "reorder proportion"
    },
    {
      "type": "richtext",
      "id": "explanation",
      "label": "explanation"
    },
    {
      "type": "image_picker",
      "id": "right_img",
      "label": "right image"
    },
    {
      "type": "richtext",
      "id": "rule",
      "label": "rule"
    },
    {
      "type": "text",
      "id": "btn_two",
      "label": "button two text"
    },
    {
      "type": "url",
      "id": "btn_two_link",
      "label": "button two link"
    }
  ],
  "presets": [
    {
      "name": "activity reorder"
    }
  ]
}
{% endschema %}