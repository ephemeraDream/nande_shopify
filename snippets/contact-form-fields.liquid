{% comment %}
------------------------------------------------------------
Contact Form Fields Snippet - 可复用的表单字段组件
支持动态显示/隐藏字段和下拉菜单
------------------------------------------------------------
{% endcomment %}

{%- if form.posted_successfully? -%}
  <p class="form-status form__message success" tabindex="-1" autofocus>
    {{ section.settings.success_message | default: 'Your message has been sent successfully.' }}
  </p>
{%- elsif form.errors -%}
  <div class="form__message error" role="alert" tabindex="-1" autofocus>
    {{ section.settings.error_message | default: 'There was an error sending the form. Please check your input.' }}
  </div>
{%- endif -%}

<div class="form-grid">
  {%- if section.settings.show_email -%}
    <div class="form-grid-field field--with-error">
      <input
        autocomplete="email"
        type="email"
        id="ContactFormFive-email"
        class="field__input"
        name="contact[email]"
        spellcheck="false"
        autocapitalize="off"
        required
        value="{% if form.email %}{{ form.email }}{% elsif customer %}{{ customer.email }}{% endif %}"
        {% if form.errors contains 'email' %}
          aria-invalid="true"
          aria-describedby="ContactFormFive-email-error"
        {% endif %}
        placeholder="{{ section.settings.mail_placeholder }}"
      >
      {%- if form.errors contains 'email' -%}
        <small class="contact__field-error" id="ContactFormFive-email-error">
          {{ form.errors.messages.email }}
        </small>
      {%- endif -%}
    </div>
  {%- endif -%}

  {%- if section.settings.show_company -%}
    <div class="form-grid-field">
      <input
        type="text"
        id="ContactFormFive-company"
        class="field__input"
        name="contact[company]"
        placeholder="{{ section.settings.company_placeholder }}"
      >
    </div>
  {%- endif -%}

  {%- if section.settings.show_name -%}
    <div class="form-grid-field">
      <input
        type="text"
        id="ContactFormFive-name"
        class="field__input"
        name="contact[name]"
        autocomplete="name"
        value="{% if form.name %}{{ form.name }}{% elsif customer %}{{ customer.name }}{% endif %}"
        placeholder="{{ section.settings.name_placeholder }}"
      >
    </div>
  {%- endif -%}

  {%- if section.settings.show_phone -%}
    <div class="form-grid-field">
      <input
        type="tel"
        id="ContactFormFive-phone"
        class="field__input"
        name="contact[phone]"
        autocomplete="tel"
        value="{% if form.phone %}{{ form.phone }}{% elsif customer %}{{ customer.phone }}{% endif %}"
        placeholder="{{ section.settings.phone_placeholder }}"
      >
    </div>
  {%- endif -%}
</div>

{%- comment -%} 处理自定义字段 {%- endcomment -%}
{%- assign custom_fields = section.blocks | where: "type", "custom_field" -%}

{%- for field in custom_fields -%}
  <div class="form-grid">
    <div class="form-grid-field{% if field.settings.field_type == 'textarea' %} all-row{% endif %}">
      {%- if field.settings.field_type == 'textarea' -%}
        <textarea
          id="ContactFormFive-{{ field.settings.field_name }}"
          name="contact[{{ field.settings.field_name }}]"
          class="text-area field__input"
          rows="{{ field.settings.rows | default: 4 }}"
          placeholder="{{ field.settings.placeholder }}"
          {% if field.settings.required %}required{% endif %}
        ></textarea>
      {%- else -%}
        <input
          type="{{ field.settings.field_type | default: 'text' }}"
          id="ContactFormFive-{{ field.settings.field_name }}"
          name="contact[{{ field.settings.field_name }}]"
          class="field__input"
          placeholder="{{ field.settings.placeholder }}"
          {% if field.settings.required %}required{% endif %}
          {% if field.settings.field_type == 'email' %}autocomplete="email"{% endif %}
          {% if field.settings.field_type == 'tel' %}autocomplete="tel"{% endif %}
          {% if field.settings.field_type == 'name' %}autocomplete="name"{% endif %}
        >
      {%- endif -%}
    </div>
  </div>
{%- endfor -%}

{%- comment -%} 处理下拉菜单 {%- endcomment -%}
{%- assign dropdowns = section.blocks | where: "type", "dropdown" -%}
{%- assign groups = section.blocks | where: "type", "group" -%}
{%- assign options = section.blocks | where: "type", "option" -%}

{%- for dropdown in dropdowns -%}
  {%- assign dropdown_key = dropdown.settings.key -%}
  <div class="form-grid">
    <div class="form-grid-field all-row">
      <select
        id="ContactFormFive-{{ dropdown_key }}"
        name="contact[{{ dropdown.settings.field_name }}]"
        class="field__input"
        {% if dropdown.settings.required %}required{% endif %}
      >
        <option value="" disabled selected hidden>{{ dropdown.settings.label }}</option>

        {%- for group in groups -%}
          {%- if group.settings.dropdown_key == dropdown_key -%}
            <optgroup label="{{ group.settings.label }}">
              {%- assign group_key = group.settings.key -%}
              {%- for opt in options -%}
                {%- if opt.settings.group_key == group_key -%}
                  <option value="{{ opt.settings.value }}">{{ opt.settings.label }}</option>
                {%- endif -%}
              {%- endfor -%}
            </optgroup>
          {%- endif -%}
        {%- endfor -%}
      </select>
    </div>
  </div>
{%- endfor -%}

{%- if section.settings.show_message -%}
  <div class="form-grid-field">
    <textarea
      rows="7"
      id="ContactFormFive-body"
      class="text-area field__input"
      name="contact[body]"
      placeholder="{{ section.settings.message_placeholder }}"
    >{{- form.body -}}</textarea>
  </div>
{%- endif -%}

<button type="submit" class="submit-button nd-btn">
  {{ section.settings.btn_text }}
  {{ 'icon-right-arrow.svg' | inline_asset_content }}
</button>
