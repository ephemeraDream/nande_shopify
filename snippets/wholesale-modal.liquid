<div class="product_info_modal_item">
  <div class="product_info_modal_item_left">
    {{ icon }}
    <span class="product_info_modal_item_title">{{ title }}</span>
  </div>
  {{- 'swiper-right.svg' | inline_asset_content -}}

  <div class="common_modal">
    <div class="common_modal_contain">
      <div class="common_modal_head">
        <span></span>
        <div class="common_modal_close">{{- 'icon-close.svg' | inline_asset_content -}}</div>
      </div>
      <div class="common_modal_body">
        <div class="product_info_modal_title">{{ modal_title }}</div>
        <div class="product_info_modal_content">{{ modal_content }}</div>
        {%- form 'contact', id: 'ContactForm', class: contact_form_class -%}
          <input
            autocomplete="email"
            type="email"
            class="field-input"
            name="contact[email]"
            spellcheck="false"
            autocapitalize="off"
            value="{% if form.email %}{{ form.email }}{% elsif customer %}{{ customer.email }}{% endif %}"
            placeholder="Emal*"
            required
          >
          <input
            class="field-input"
            type="text"
            name="contact[Unternehmen]"
            placeholder="Unternehmen (optional)"
          >
          <input
            class="field-input"
            autocomplete="name"
            type="text"
            name="contact[Name]"
            value="{% if form.name %}{{ form.name }}{% elsif customer %}{{ customer.name }}{% endif %}"
            placeholder="Name (optional)"
          >
          <textarea
            rows="6"
            id="ContactForm-body"
            class="field-input"
            name="contact[Nachricht]"
            placeholder="Nachricht (optional)"
          >
            {{- form.body -}}
          </textarea>
          <div class="contact-btn">
            <button type="submit">
              {{ 'common.absenden' | t -}}
              {{- 'icon-commit.svg' | inline_asset_content }}
            </button>
          </div>
        {%- endform -%}
        <div id="ContactForm-message" class="contact-message" style="display:none;"></div>
        <div class="product_info_modal_tip">{{ modal_tip }}</div>
      </div>
    </div>
  </div>
</div>

<script>
  () => {
    document.addEventListener('DOMContentLoaded', () => {
      const form = document.getElementById('ContactForm');
      const messageBox = document.getElementById('ContactForm-message');

      form.addEventListener('submit', async (e) => {
        e.preventDefault();

        messageBox.style.display = 'none';
        messageBox.innerHTML = '';

        const formData = new FormData(form);

        try {
          const res = await fetch('/contact', {
            method: 'POST',
            body: formData,
            headers: {
              'X-Requested-With': 'XMLHttpRequest',
            },
          });

          const text = await res.text();

          if (text.includes('contact[success]')) {
            messageBox.innerHTML = '✅ Vielen Dank! Ihre Nachricht wurde gesendet.';
            messageBox.style.color = 'green';
          } else {
            messageBox.innerHTML = '❌ Etwas ist schiefgelaufen. Bitte versuchen Sie es erneut.';
            messageBox.style.color = 'red';
          }

          messageBox.style.display = 'block';
          form.reset();
        } catch (err) {
          messageBox.innerHTML = '❌ Netzwerkfehler. Bitte versuchen Sie es später erneut.';
          messageBox.style.color = 'red';
          messageBox.style.display = 'block';
        }
      });
    });
  };
</script>
